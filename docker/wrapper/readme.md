# Data.gov.ua wrapper v.1.0

## **1. Введение.**

Программа предназначена дла предоставления api по аналогии с ресурсом **data.gov.ua** для его подмены, если отправляемые ему запросы возвращаются с ошибкой.

Настройка программы выполняется с помощью файла конфигурации *config.ini* и передачей аргументов в командной строке.

## **2. Кофигурация.**
### **2.1. Состав файлов и папок.**

- **/files**. Папка в которой собраны файлы данных. Эта папка может содержать вложенные папки, если есть необходимость;
- **/ssl**. Папка в которой могут быть размещены файлы key.pem и cert.pem если сервер должен использовать протокол https;
- **config.ini** - файл конфигурации;
- **wrapper.py** - выполняемый Python-файл;
- **readme.md** - этот файл.

### **2.2. Файл конфигурации.**

Файл конфигурации содержит разделы параметров, которые являются обязательными:

- **server**. Общие данные используемые сервером;
- **proxies**. Настройки proxy (сами настройки не являются обязательными);
- **packages**. Словарь (api-key: resource_id) для идентификации локальных ресурсов в соответствии с набором данных **data.gov.ua** *;
- **files**. Словарь (resource_id: fileName) для свзывания идентификторов ресурсов с относительными именами файлов;
- **direct-links**. Словарь (resource_id, url) для назначения ссылок на загружаемые файлы, если они не могут быть сформированы на общих основаниях. \*\*.

\* значение идентификатора ресурса может начинаться с символа '@', это означает что набор данных требует дополнительного указания имени ресурса и/или может содержать несколько ресурсов. При этом, идентификатор (с опущенным префиксом '@') определяет название раздела файла конфигурации, в котором содержится словарь (resource_name: resource_id). Подобную расшифровку можно обнаружить для источников govua4, govua12.

\*\* Формирование ссылок на общих основаниях предполагает использование параметров *server.domain*, *server.absolute*, *server.url_path* (см. п. 2.2.1).

#### **2.2.1. Параметры раздела **"server"**:**

- **address**. Локальный адрес сервера;
- **domain**. Название домена, используемое при формировании URL для ссылки на загружаемый файл;
- **absolute**. Признак того, что параметр **domain** содержит префикс URL для загружаемых файлов (включая протокол, полное имя домена, порт, и возможно также имя пользователя, пароль и базовый путь), в противном случае, префикс URL формируется на основании параметров **https**, **domain**, **port**, где **domain** может включать имя пользователя и пароль;
- **port**. Номер порта сервера;
- **main_package_url**. Шаблон URL для получения информации о наборе данных (обычно *"https://data.gov.ua/api/3/action/package_show?id={id}*"). Параметр {id} будет подменен на идентификатор набора данных (***api-key***);
- **main_resource_url**. Шаблон URL для получения информации о ревизиях ресурса (обычно *"https://data.gov.ua/api/3/action/resource_show?id={id}*"). Параметр {id} будет подменен на идентификатор ресурса;
- **https**. Признак использования протокола https (true/false);
- **revisionDate**. Дата в ISO-формате, которая соответствует дате ревизии для всех предоставляемых файлов данных;
- **url_path**. Шаблон пути для формирования ссылки на загружаемые файлы (обычно *"/api/3/action/download?file={file}"*, чтобы соответствовать ресурсу ***data.gov.ua***). Параметр {file} будет подменен на имя файлa, указанного в разделе [**files**], в соответствии с идентификатором ресурса;
- **path**. Путь к расположению локальных папок */files* и */ssl*. Если путь пустой, или не задан, проверяется значение параметра **env_var**;
- **env_var**. Имя переменной окружения, в которой записан путь по умолчанию (см. **path**). Обычно ***env_var=OTP_TEMP***;
- **env_var_append_wrapper**'. Признак (true/false) того, что к пути, записанному в переменной окружения, добавляется */wrapper*. Если переменная окружения соответствует расположению NFS (в том числе и эмулируемого), то данный параметр должен быть равен true.

#### **2.2.2. Параметры раздела **proxies****

- **http**. Строка идентифицирующая proxy-сервер для протокола http. Формат \<server>:\<port>;
- **https**. Строка идентифицирующая proxy-сервер для протокола https. Формат \<server>:\<port>.

### **2.3. Аргументы командной строки.**

Аргументы командной строки определяют значения параметров конфигурации и  задаются в формате *section.name=value*, где section - это имя раздела файла конфигурации, name - имя параметра и value - значение (например, server.port=8120).
Аргументы командной строки применяются к ранее загруженному файлу конфигурации, поэтому являются доминирующими.

## **3. Настройка и запуск приложения.**

### **3.1. Для разработчика.**

Для работы ***Wrapper*** необходимо установить **Python** (https://www.python.org/downloads/).

Приложение сервера расположено в локальной папке проекта **otp-repo**:  *docker/wrapper/wrapper.py*. Для запуска приложения, нужно перейти в папку *docker/wrapper* и запустить *python wrapper.py [args]* (*args* - необязательный набор параметров, см. п.п. 2.3).

Желательно освободить порт **9559** для ***Wrapper***, чтобы не пришлось вызывать сервис *downloader* из терминала с параметром *data.gov.ua.domain=http://localhost:XXXX*.

Некоторые сервисы проекта **OTP-ETL** имеют параметры в *application.properties*, связанные с указанием директории для обмена файлами между сервисами. Обычно используется два параметра:
- **\<xxx\>.outputFolder=**\
  Прямое указание пути к директории. Значение обычно пустое и может быть подменено параметрами командной строки;

- **\<xxx\>.defaultEnvironmentVariableForOutputFolder=OTP_TEMP**. \
  Указание переменной окружения, в которой может быть записан путь к директории.

***Wrapper*** - не является исключением, и содержит параметры настройки, аналогичные сервисам **OTP-ETL** (см. п.2.2.1. *path*, *env_var*, *env_var_append_wrapper*).

Целесообразно использовать одну переменную окружения (***OTP_TEMP***) для всех сервисов, которые пользуются обменом файлами (установлено в сервисах по умолчанию, включая ***Wrapper***). Например, для **Windows**:
- Создать папку, например, *D:\OTP_NFS*;
- Разместить в ней папку ***base*** и наполнить ее файлами базовых источников (*passports*, *base_fodb*, и т.д.);
- Разместить в ней папку ***wrapper*** и поместить в нее содержимое репозитория ***otp_data/govua*** (P.S. на данный момент это не обязательно, потому что файл настроек (config.ini)  содержит прямые ссылки на **google disk**);
- Создать переменную окружения *OTP_TEMP=D:\OTP_NFS*, после чего перегрузить компьютер.

Таким образом, все сервисы, включая ***Wrapper***, связаны с одной директорией.


### **3.2. Для запуска в контейнере.**

Необходимо иметь установленный ***Docker Desktop***.

Для непосредственной сборки образа нужно перейти в папку ***otp_repo/docker/wrapper***,
и выполнить команду из терминала:
```
docker build -t base-wrapper .
```
Запуск контейнера выглядит так:
```
docker run --rm -it --name base-wrapper-container -v "d:/OTP_NFS/wrapper/files:/usr/src/wrapper/files" -p9559:9559 base-wrapper
```
P.S. название образа (base-wrapper) и название контейнера (base-wrapper-container) могут быть заменены.

Все те же действия можно выполнить с помощью настройки конфигурации для запуска ***otp-repo/docker/wrapper/Dockerfile*** средствами **IntelliJ IDEA**.

Том (*volume*) можно заранее приготовить в **Docker**, и не пользоваться ссылкой на локальную папку:
```
docker run --rm -it --name base-wrapper-container -v "govua-files:/usr/src/wrapper/files" -p9559:9559 base-wrapper
```

Для создания постоянного тома **govua-files** можно воспользоваться средствами интерфейса **Docker Desktop**, или выполнить команду в терминале:
```
docker volume create govua-files
```
Для предварительного формирования тома **govua-files** можно воспользоваться временным контейнером, например так:
```
docker container create --name temp -v govua-files:/data busybox
docker cp d:/OTP_NFS/wrapper/files/. temp:/data
docker rm temp
```
или воспользоваться готовым **base-wrapper**:
```
docker container create --name temp -v govua-files:/usr/src/wrapper/files base-wrapper
docker cp d:/OTP_NFS/wrapper/files/. temp:/usr/src/wrapper/files
docker rm temp
```

P.S. Все перечисленные примеры предполагают, что файлы данных для ***Wrapper*** расположены в папке *d:/OTP_NFS/wrapper/files*.

Для сборки образа и запуска контейнера средствами **docker-compose** (**otp-repo/docker-compose.yml**) необходимо иметь готовый том **govua-files**.


